{{ define "render-link" }}
  <a class="link link--internal" href="{{ .href }}">
    {{ .text }}
    {{ partial "components/icon" (dict "name" "folder-symlink") }}
  </a>
{{ end }}

{{ define "render-broken" }}
  <span class="link link--broken" title="{{ i18n "missingLink" }}">
    {{ .text }}
    {{ partial "components/icon" (dict "name" "x-circle") }}
  </span>
{{ end }}

{{ if site.Params.wikilink | default true }}
  {{- $destination := .Destination | default "" -}}
  {{- $text := .Text | safeHTML | default "" -}}
  {{- $title := .Title | default "" -}}

  {{- $regularPages := where site.RegularPages "Lang" $.Page.Lang -}}

  {{- $isWikilink := eq $destination "wikilink" -}}
  {{- $isExternal := or
    (strings.HasPrefix $destination "http://")
    (strings.HasPrefix $destination "https://")
    (strings.HasPrefix $destination "mailto:")
  -}}

  {{ if $isWikilink }}
    {{ $rawTitle := cond (ne $title "") $title $text }}
    {{ $parts := split $rawTitle "#" }}
    {{ $targetRaw := index $parts 0 }}
    {{ $target := path.Base $targetRaw }}
    {{ $anchor := cond (gt (len $parts) 1) (printf "#%s" (index $parts 1)) "" }}

    {{ $page := "" }}
    {{ range $regularPages }}
      {{ if and (ne .File nil) (or
        (eq .File.BaseFileName $target)
        (eq .File.TranslationBaseName $target)
        (in .Aliases $target)
        )
      }}
        {{ $page = . }}
        {{ break }}
      {{ end }}
    {{ end }}

    {{ if $page }}
      {{ template "render-link" (dict "href" (print $page.RelPermalink $anchor) "text" $text) }}
    {{ else }}
      {{ template "render-broken" (dict "text" $text) }}
    {{ end }}

  {{ else if not $isExternal }}
    {{ $parts := split $destination "#" }}
    {{ $target := index $parts 0 }}
    {{ $anchor := cond (gt (len $parts) 1) (printf "#%s" (index $parts 1)) "" }}

    {{ $page := "" }}
    {{ range $regularPages }}
      {{ if and (ne .File nil) (or
        (eq .File.BaseFileName $target)
        (eq .File.TranslationBaseName $target)
        (in .Aliases $destination)
        )
      }}
        {{ $page = . }}
        {{ break }}
      {{ end }}
    {{ end }}

    {{ if $page }}
      {{ template "render-link" (dict "href" (print $page.RelPermalink $anchor) "text" $text) }}
    {{ else }}
      {{ template "render-broken" (dict "text" $text) }}
    {{ end }}

  {{ else }}
    <a
      class="link link--external"
      href="{{ $destination | safeURL }}"
      rel="external noopener noreferrer nofollow"
      target="_blank"
    >
      {{ $text }}
      {{ partial "components/icon" (dict "name" "box-arrow-up-right") }}
    </a>
  {{ end }}

{{ else }}
  {{- $u := urls.Parse .Destination -}}
  <a
    href="{{ .Destination | safeURL }}"
    {{- with .Title }}title="{{ . }}"{{ end -}}
    {{- if $u.IsAbs }}
      rel="external noopener noreferrer nofollow" target="_blank"
    {{ end -}}
    class="link {{ if $u.IsAbs }}
      link--external
    {{ else }}
      link--internal
    {{ end }}"
  >
    {{- with .Text }}{{ . }}{{ end -}}

    {{- if $u.IsAbs }}
      {{ partial "components/icon" (dict "name" "box-arrow-up-right") }}
    {{ else -}}
      {{ partial "components/icon" (dict "name" "folder-symlink") }}
    {{ end }}
  </a>
{{ end }}
